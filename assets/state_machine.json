{
  "Comment": "State machine for detecting language, transcribing, translating, and synthesizing speech",
  "StartAt": "DetectLanguage",
  "States": {
    "DetectLanguage": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:transcribe:startTranscriptionJob",
      "Parameters": {
        "TranscriptionJobName.$": "States.Format('DetectLanguageJob-{}', $.id)",
        "Media": {
          "MediaFileUri.$": "States.Format('s3://{}/{}', $.detail.requestParameters.bucketName, $.detail.requestParameters.key)"
        },
        "IdentifyLanguage": true,
        "OutputBucketName.$": "$.detail.requestParameters.bucketName",
        "OutputKey.$": "States.Format('transcriptions/{}-transcription.json', $.id)"
      },
      "ResultPath": "$.DetectLanguageOutput",
      "Next": "WaitForLanguageDetection",
      "Retry": [
        {
          "ErrorEquals": ["States.ALL"],
          "IntervalSeconds": 5,
          "MaxAttempts": 3,
          "BackoffRate": 2
        }
      ],
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "FailState"
        }
      ]
    },
    "WaitForLanguageDetection": {
      "Type": "Wait",
      "Seconds": 30,
      "Next": "GetLanguageDetectionStatus"
    },
    "GetLanguageDetectionStatus": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:transcribe:getTranscriptionJob",
      "Parameters": {
        "TranscriptionJobName.$": "$.DetectLanguageOutput.TranscriptionJob.TranscriptionJobName"
      },
      "ResultPath": "$.GetLanguageDetectionOutput",
      "Next": "CheckLanguageDetectionStatus",
      "Retry": [
        {
          "ErrorEquals": ["States.ALL"],
          "IntervalSeconds": 5,
          "MaxAttempts": 3,
          "BackoffRate": 2
        }
      ],
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "FailState"
        }
      ]
    },
    "CheckLanguageDetectionStatus": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.GetLanguageDetectionOutput.TranscriptionJob.TranscriptionJobStatus",
          "StringEquals": "COMPLETED",
          "Next": "CheckDetectedLanguage"
        },
        {
          "Variable": "$.GetLanguageDetectionOutput.TranscriptionJob.TranscriptionJobStatus",
          "StringEquals": "FAILED",
          "Next": "FailState"
        }
      ],
      "Default": "WaitForLanguageDetection"
    },
    "CheckDetectedLanguage": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.GetLanguageDetectionOutput.TranscriptionJob.LanguageCode",
          "StringEquals": "en-US",
          "Next": "IgnoreWorkflow"
        },
        {
          "Not": {
            "Variable": "$.GetLanguageDetectionOutput.TranscriptionJob.LanguageCode",
            "StringEquals": "en-US"
          },
          "Next": "GetObject"
        }
      ]
    },
    "GetObject": {
      "Type": "Task",
      "Parameters": {
        "Bucket.$": "$.detail.requestParameters.bucketName",
        "Key.$": "States.Format('transcriptions/{}-transcription.json', $.id)"
      },
      "Resource": "arn:aws:states:::aws-sdk:s3:getObject",
      "ResultPath": "$.TranscriptionOutput",
      "Next": "ParseJson"
    },
    "ParseJson": {
      "Type": "Pass",
      "Parameters": {
        "TranscriptionJson.$": "States.StringToJson($.TranscriptionOutput.Body)"
      },
      "ResultPath": "$.ParsedTranscription",
      "Next": "ExtractText"
    },
    "ExtractText": {
      "Type": "Pass",
      "Parameters": {
        "TranscriptText.$": "$.ParsedTranscription.TranscriptionJson.results.transcripts[0].transcript"
      },
      "ResultPath": "$.ExtractedText",
      "Next": "StartTranslationJob"
    },
    "IgnoreWorkflow": {
      "Type": "Pass",
      "Result": "Language is English, workflow ignored.",
      "End": true
    },
    "StartTranslationJob": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:translate:translateText",
      "Parameters": {
        "Text.$": "$.ExtractedText.TranscriptText",
        "SourceLanguageCode.$": "$.GetLanguageDetectionOutput.TranscriptionJob.LanguageCode",
        "TargetLanguageCode": "en"
      },
      "ResultPath": "$.StartTranslationOutput",
      "Next": "StartSpeechSynthesisTask",
      "Retry": [
        {
          "ErrorEquals": ["States.ALL"],
          "IntervalSeconds": 5,
          "MaxAttempts": 3,
          "BackoffRate": 2
        }
      ],
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "FailState"
        }
      ]
    },
    "StartSpeechSynthesisTask": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:polly:startSpeechSynthesisTask",
      "Parameters": {
        "OutputS3BucketName.$": "$.detail.requestParameters.bucketName",
        "OutputS3KeyPrefix": "translations/",
        "Text.$": "$.StartTranslationOutput.TranslatedText",
        "VoiceId": "Joanna",
        "OutputFormat": "mp3"
      },
      "Next": "SuccessState",
      "Retry": [
        {
          "ErrorEquals": ["States.ALL"],
          "IntervalSeconds": 5,
          "MaxAttempts": 3,
          "BackoffRate": 2
        }
      ],
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "FailState"
        }
      ]
    },
    "SuccessState": {
      "Type": "Succeed"
    },
    "FailState": {
      "Type": "Fail",
      "Error": "ProcessFailed",
      "Cause": "$.Error"
    }
  }
}
